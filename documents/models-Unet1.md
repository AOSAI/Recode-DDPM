## 1. ä¸»ç±» SimpleUNet

### 1.1 æ—¶é—´æ­¥åµŒå…¥å’Œçº¿æ€§å˜æ¢

```py
# æ„é€ å‡½æ•° init ä¸­
time_emb_dim = base_channels * 4
self.time_embedding = nn.Sequential(...)

# forward ä¸­
t_emb = timestep_embedding(t, self.base_channels).to(x.device)
t_emb = self.time_embedding(t_emb)
```

ç¬¬ä¸€æ­¥ï¼Œå°†æ—¶é—´æ­¥é€šè¿‡ timestep_embedding ç¼–ç æˆæ­£ä½™å¼¦é«˜ç»´è¡¨ç¤ºï¼Œæ˜¯ä¸ºäº†è®©æ¨¡å‹åœ¨èµ°å·ç§¯æ—¶ï¼ŒçŸ¥é“è‡ªå·±èµ°åˆ°å“ªäº†ã€‚ç„¶åé€šè¿‡ä¸€ä¸ª time_embedding èµ°ä¸¤å±‚çº¿æ€§å˜æ¢ï¼Œæ˜¯ä¸ºäº†æå‡æ—¶é—´è¡¨ç¤ºçš„è¡¨è¾¾èƒ½åŠ›ï¼ŒçŸ¥é“è‡ªå·±è¯¥å¹²ä»€ä¹ˆã€‚

è¿™ä¹ˆè¯´çœŸçš„éå¸¸çš„æŠ½è±¡ï¼Œæˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬çš„æ—¶é—´æ­¥ t æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œæ¯”å¦‚ 37ï¼Œè¿™å°±åƒä½ æ‰‹é‡Œæ‹¿ç€ä¸€å¼ çº¸æ¡ï¼Œå†™ç€ï¼š"ä»Šå¤©æ˜¯æ‰©æ•£çš„ç¬¬ 37 æ­¥"ã€‚

ä½†æ˜¯ç¥ç»ç½‘ç»œæ˜¯ä¸æ‡‚è¿™ä¸ªâ€œ37â€çš„å«ä¹‰çš„ï¼Œå®ƒè¦ç†è§£è¿™ä¸ªâ€œæ—¶é—´æ¦‚å¿µâ€ï¼Œå°±åƒä½ è¦æŠŠâ€œç¬¬ 37 å¤©çš„çŠ¶æ€â€ç¿»è¯‘æˆä¸€æ®µå¯ç†è§£çš„è¯­è¨€ï¼Œå‘Šè¯‰ç½‘ç»œï¼šâ€œå“¦ï¼Œæˆ‘ç°åœ¨å¤„äºä¸€ä¸ªä¸­æœŸé˜¶æ®µï¼Œå™ªå£°ä¸æ˜¯å¾ˆå¤§ä¹Ÿä¸æ˜¯å¾ˆå°ï¼Œæˆ‘éœ€è¦å¼€å§‹è¿˜åŸå›¾åƒçš„ä¸€äº›ç»†èŠ‚äº†â€¦â€¦â€ã€‚

ğŸ’¡ é‚£æˆ‘ä»¬æ˜¯æ€ä¹ˆç¿»è¯‘çš„å‘¢ï¼Ÿä¸Šè¿°æµç¨‹æ˜¯è¿™æ ·çš„ï¼Œæˆ‘ä»¬ä¸€å…±åšäº†ä¸‰ä»¶äº‹ï¼š

```py
SinusoidalEmbedding â†’ Linear(64 â†’ 256) â†’ ReLU â†’ Linear(256 â†’ 256)
```

**1. ç”¨æ­£å¼¦å‡½æ•°å°†æ•´æ•° t ç¼–ç æˆä¸€ä¸ªâ€œé¢‘ç‡ç©ºé—´â€é‡Œçš„å‘é‡ï¼ˆSinusoidalï¼‰**ï¼šå°±åƒä½ åœ¨ä¸åŒé¢‘ç‡ä¸Šæµ‹äº†ä¸€ä¸‹â€œç¬¬ 37 å¤©â€çš„ååº”ï¼Œè¿™è®©ç½‘ç»œå¯ä»¥åŒºåˆ†ä¸åŒæ—¶é—´æ­¥ã€‚

**2. ç¬¬ä¸€å±‚ Linear + ReLUï¼šæ˜ å°„æˆä¸€ä¸ªâ€œæ—¶é—´è¯­ä¹‰ç©ºé—´â€**ï¼šå°±åƒä½ è¯·äº†ä¸€ä¸ªç¿»è¯‘ï¼ŒæŠŠâ€œé¢‘ç‡å‘é‡â€å˜æˆäº†ä¸€æ®µæœ‰æ„ä¹‰çš„æè¿°ï¼Œæ¯”å¦‚â€œç¬¬ 37 å¤©å¤§è‡´å¤„äºæ”¶å°¾é˜¶æ®µâ€ã€‚

**3. ç¬¬äºŒå±‚ Linearï¼šç²¾ç»†è°ƒä¸€ä¸‹è¯­æ°”å’Œå¥å¼**:å°±åƒä½ åœ¨æ¶¦è‰²é‚£æ®µè¯ï¼Œè®©ä¸åŒå±‚çš„ç½‘ç»œèƒ½å¬æ‡‚ï¼Œæ¯”å¦‚å·ç§¯ç½‘ç»œèƒ½ç†è§£è¿™ä¸ªæ—¶é—´å«ä¹‰ã€‚

å¦‚æœæˆ‘ä»¬ä¸ç”¨ ReLUã€åªç”¨ä¸€ä¸ªçº¿æ€§å±‚ï¼šé‚£å¾—åˆ°çš„æ—¶é—´åµŒå…¥åªæ˜¯ä¸€ä¸ªâ€œçº¿æ€§æ˜ å°„â€ï¼Œå®ƒåªæ˜¯æ¢äº†ä¸ªåæ ‡ç³»ï¼Œä½†å®ƒæœ¬è´¨çš„ä¿¡æ¯æ²¡æœ‰å¤ªå¤šå˜åŒ–ã€‚ä½†æ˜¯åŠ äº† ReLUï¼Œç›¸å½“äºåŠ äº†ä¸€ä¸ª éçº¿æ€§æ‹ç‚¹ï¼Œå®ƒå¯ä»¥è®©é«˜ç»´ç©ºé—´ä¸­çš„ä¸åŒæ—¶é—´æ­¥ä¹‹é—´çš„â€œè¯­ä¹‰å·®å¼‚â€æ›´æ˜æ˜¾ï¼Œèƒ½åŒºåˆ†å‡º 0 æ­¥ã€128 æ­¥å’Œ 999 æ­¥è¿™å‡ ç§æˆªç„¶ä¸åŒçš„çŠ¶æ€ã€‚

å°±å¥½åƒä½ ä¸€å¼€å§‹åªè¯´äº†ï¼šâ€œä»Šå¤©ç¬¬ 37 å¤©â€ã€‚æœ€åå´å˜æˆäº†ï¼šâ€œä»Šå¤©æ˜¯ç¬¬ 37 å¤©ï¼Œæ„å‘³ç€å›¾åƒè¯¥å¼€å§‹ç»†åŒ–äº†ï¼Œè¯·å°†è¾¹ç¼˜é”åŒ–å¹¶é™ä½èƒŒæ™¯å™ªå£°â€ã€‚è¿™å°±æ˜¯æ‰€è°“çš„ ==æå‡æ—¶é—´åµŒå…¥çš„è¡¨è¾¾èƒ½åŠ›==ã€‚

### 1.2 è¾“å…¥å±‚å’Œè¾“å‡ºå±‚

```py
# æ„é€ å‡½æ•° init ä¸­
self.input_conv = nn.Conv2d(in_channels, base_channels, 3, padding=1)
self.output_conv = nn.Sequential(...)

# forward ä¸­
h = self.input_conv(x)
return self.output_conv(h)
```

åœ¨ä¸Šé‡‡æ ·å’Œä¸‹é‡‡æ ·ä¸­ï¼Œæˆ‘ä»¬è®¾ç½®äº†é€šé“æ•°å¢åŠ çš„å€ç‡ï¼ˆä¹Ÿæ˜¯å›¾åƒç¼©å°çš„å€ç‡ï¼‰ï¼šchannel_mults=(1, 2, 4)ã€‚åŒæ—¶æˆ‘ä»¬ä¹Ÿè®¾ç½®äº†ï¼ŒåŸºç¡€çš„é€šé“æ•° base_channels=64ï¼Œä½†æ˜¯æˆ‘ä»¬çš„è¾“å…¥é€šé“æ•°æ˜¯ 3ï¼Œå¯¹äºç¬¬ä¸€æ¬¡ä¸‹é‡‡æ ·çš„å€ç‡ 1 æ¥è¯´ï¼Œ64 != 3ï¼Œæ‰€ä»¥æˆ‘ä»¬åšäº†ä¸€ä¸ªè¾“å…¥çš„å·ç§¯ï¼Œå°†å…¶æå‡è‡³ 64 ç»´ã€‚

è¾“å‡ºçš„è®¾å®šå°±æœ‰æ„æ€äº†ï¼šGroupNorm â†’ SiLU â†’ Conv2d

1. åœ¨ U-Net è¿™ç§ç»“æ„ä¸­ï¼Œè§£ç ï¼ˆä¸Šé‡‡æ ·ï¼‰åå¾—åˆ°çš„ç‰¹å¾å›¾ä¼šæœ‰å¾ˆå¤šä¸å‡è¡¡çš„å€¼ï¼Œæ¯”å¦‚æœ‰çš„åŒºåŸŸç‰¹åˆ«æ¿€æ´»ã€æœ‰çš„æ²¡å•¥ä¿¡å·ã€‚å¦‚æœç›´æ¥è¾“å‡ºï¼Œå¯èƒ½å¯¼è‡´å›¾åƒä¸ç¨³å®šã€æœ‰åå·®ã€‚GroupNorm(32, ch) å¯ä»¥ç†è§£ä¸ºï¼š

   - å°†é€šé“æŒ‰ç»„åˆ‡å¼€ï¼ˆæ¯”å¦‚ 64 ä¸ªé€šé“åˆ†æˆ 2 ç»„ï¼Œæ¯ç»„ 32 ä¸ªï¼‰
   - æ¯ç»„å•ç‹¬æ ‡å‡†åŒ–ï¼Œå¹³è¡¡å„ç»„çš„æ•°å€¼èŒƒå›´ã€‚
   - å¯¹å° batch æ›´ç¨³å®šï¼Œé€‚åˆç”Ÿæˆä»»åŠ¡ï¼ˆæ¯” BatchNorm æ›´å¯é ï¼‰

2. SiLUï¼ˆSwishï¼‰æ˜¯ï¼šx \* sigmoid(x)ã€‚ç›¸æ¯” ReLU æ›´å¹³æ»‘ï¼Œåœ¨ç”Ÿæˆä»»åŠ¡ä¸­å¸¸è§ï¼Œå› ä¸ºå®ƒï¼š

   - ä¸ä¼šå®Œå…¨æŠ›å¼ƒè´Ÿå€¼ï¼ˆä¸åƒ ReLU æˆªæ–­ï¼‰
   - åœ¨è®­ç»ƒåæœŸï¼Œèƒ½è®©è¾“å‡ºæ›´ç»†è…»

3. Conv2d è¾“å‡º RGBï¼šç»“åˆæ‰€æœ‰ç‰¹å¾ï¼Œç”Ÿæˆä¸‰é€šé“å›¾åƒã€‚

æ‹¿åšé¥­æ¥æ¯”å–»ï¼Œå¦‚æœç›´æ¥å·ç§¯è¾“å‡ºï¼Œå°±åƒ Unet2 ä¸­çš„æ“ä½œä¸€æ ·ï¼šâ€œç›´æ¥ä¸€é”…ç«¯â€ã€‚ä½†æ˜¯æŒ‰ç…§ç°åœ¨è¿™ä¸ªæ­¥éª¤æ¥åšï¼Œç›¸å½“äºæ˜¯ï¼šğŸ§‚ åŠ ç‚¹è°ƒå‘³æ–™ï¼ˆå½’ä¸€åŒ–ï¼‰ï¼ŒğŸ”¥ ç²¾ç»†åŠ çƒ­ï¼ˆæ¿€æ´»å‡½æ•°ï¼‰ï¼ŒğŸ½ï¸ å†è£…ç›˜ï¼ˆæœ€åå·ç§¯è¾“å‡ºï¼‰ã€‚ä¼˜é›…ç¾å‘³ã€‚

æœ€åï¼Œforward å‡½æ•°ä¸­çš„ hï¼Œå®ƒå°±æ˜¯æ¯ä¸€æ­¥è¿›è¡Œæ“ä½œçš„å¯¹è±¡ã€‚

### 1.3 ä¸‹é‡‡æ ·å’Œä¸Šé‡‡æ ·

è¿™éƒ¨åˆ†çš„ä»£ç æ¯”è¾ƒå¤šï¼Œå°±ä¸è´´äº†ï¼Œç®€å•è®²ä¸€ä¸‹ï¼Œæˆ‘ä»¬æœ‰ 2 ä¸ªæ®‹å·®å—ï¼Œ3 ä¸ªé€šé“ç¼©æ”¾å€ç‡ï¼Œskip_channels ç”¨æ¥ä¿å­˜æ¯ä¸€æ¬¡çš„é€šé“æ•°å˜æ¢ï¼Œå¦‚æœæŠŠä¸‹é‡‡æ ·é˜¶æ®µï¼Œå¹³é“ºçš„å†™æˆ ModuleList çš„å½¢å¼ï¼š

```py
self.down_blocks = nn.ModuleList([
    # level 0
    ResidualBlock(64, 64, time_emb_dim),  # ç¬¬ä¸€ä¸ªResBlock
    ResidualBlock(64, 64, time_emb_dim),  # ç¬¬äºŒä¸ªResBlock
    Downsample(64),                       # ä¸‹é‡‡æ ·

    # level 1
    ResidualBlock(64, 128, time_emb_dim), # é€šé“æ•°å˜æ¢ + æ—¶é—´èåˆ
    ResidualBlock(128, 128, time_emb_dim),# ä¿æŒé€šé“æ•°
    Downsample(128),                      # åªå‡å°ç©ºé—´å°ºå¯¸ï¼Œä¹Ÿå°±æ˜¯å›¾åƒ Size

    # level 2ï¼ˆæœ€åä¸€å±‚ï¼Œä¸åŠ  Downsampleï¼‰
    ResidualBlock(128, 256, time_emb_dim),
    ResidualBlock(256, 256, time_emb_dim),
])
skip_channels = [64, 64, 128, 128, 256, 256]
```

ä¸çŸ¥é“æœ‰æ²¡æœ‰ä¸€äº›å°ç™½é“å‹ï¼Œå’Œæˆ‘åˆšå¼€å§‹ä¸€æ ·æ‡µé€¼ï¼Œä¸ºä»€ä¹ˆä¸‹é‡‡æ ·çš„æ—¶å€™é€šé“æ•°æ˜¯ä¿æŒä¸€è‡´çš„ï¼Ÿè¿™æ˜¯å› ä¸º U-Net çš„è®¾è®¡æ€æƒ³é‡Œï¼Œæ¨¡å—åŠŸèƒ½æ˜¯â€œè§£è€¦çš„â€ï¼šDownsample ä¸“æ³¨åšâ€œç©ºé—´å°ºå¯¸ç¼©å°â€ï¼Œè€Œä¸æ˜¯å¤„ç†é€šé“å˜åŒ–ã€‚

| æ¨¡å—          | ä¸»è¦ä½œç”¨             |
| ------------- | -------------------- |
| ResidualBlock | æå–ç‰¹å¾ + é€šé“è½¬æ¢  |
| Downsample    | ç¼©å°ç©ºé—´å°ºå¯¸ï¼ˆH, Wï¼‰ |
| Upsample      | æ”¾å¤§ç©ºé—´å°ºå¯¸ï¼ˆH, Wï¼‰ |

è™½ç„¶æœ‰äº›è®ºæ–‡é‡Œç¡®å®ä¼šåœ¨ downsample çš„åŒæ—¶å‡é€šé“ï¼Œé‚£æ˜¯ä¸ºäº†å‡å°‘å‚æ•°ã€å‡å°‘æ˜¾å­˜ï¼Œä¸è¿‡ å¯è§£é‡Šæ€§å’Œæ¨¡å—åŒ–æ€§ä¼šä¸‹é™ï¼Œä¸å¦‚ç›®å‰è¿™ç§æ¸…æ™°çš„ç»“æ„ã€‚

å…¶ä½™çš„ï¼Œä¸Šé‡‡æ ·ï¼Œè·³è·ƒè¿æ¥ï¼Œç‰¹å¾å åŠ è¿˜æ˜¯éœ€è¦è®²ä¸€è®²çš„ã€‚åŒç†ï¼Œä¸Šé‡‡æ ·çš„å¹³é“ºå½¢å¼ä¸ºï¼š

```py
skip_channels = [64, 64, 128, 128, 256, 256]
self.up_blocks = nn.ModuleList([
    # Level 2: mult = 4 â†’ out_ch = 256
    ResidualBlock(256 + skip_channels.pop(), 256, time_emb_dim),
    ResidualBlock(256 + skip_channels.pop(), 256, time_emb_dim),
    Upsample(256),

    # Level 1: mult = 2 â†’ out_ch = 128
    ResidualBlock(256 + skip_channels.pop(), 128, time_emb_dim),
    ResidualBlock(128 + skip_channels.pop(), 128, time_emb_dim),
    Upsample(128),

    # Level 0: mult = 1 â†’ out_ch = 64
    ResidualBlock(128 + skip_channels.pop(), 64, time_emb_dim),
    ResidualBlock(64 + skip_channels.pop(), 64, time_emb_dim),
    # ğŸš« no Upsample here
])
```

è¿™é‡Œä¸ºä»€ä¹ˆè¦åŠ  skip_channels.pop()ï¼Œå°±æ˜¯ä¸ºäº†==è·³è·ƒè¿æ¥ï¼Œç‰¹å¾å åŠ ==ï¼š

- ğŸ”½ ä¸‹é‡‡æ ·çš„æ—¶å€™ï¼šæˆ‘ä»¬åªæ˜¯ä¸€è·¯èµ°åˆ°åº•ï¼Œä¸æ–­ç¼©å°å›¾åƒç©ºé—´å°ºå¯¸ï¼ŒæŠŠå›¾åƒä» 64x64 â†’ 32x32 â†’ 16x16...

- ğŸ”¼ ä¸Šé‡‡æ ·çš„æ—¶å€™ï¼šæˆ‘ä»¬è¦ä¸€è¾¹æ¢å¤ç©ºé—´å°ºå¯¸ï¼Œä¸€è¾¹æŠŠä¹‹å‰ç»†èŠ‚è¡¥å›æ¥ï¼Œæ‰€ä»¥ç”¨ä¸Šäº†è·³è·ƒè¿æ¥ï¼ˆskip connectionï¼‰

å¾ˆå¥½ç†è§£å¯¹å§ï¼Œæˆ‘ä»¬åœ¨ç¼©å°å›¾åƒçš„æ—¶å€™ï¼Œèƒ½å¤Ÿä¿ç•™å¤§è‡´çš„ä¸»ä½“ä¿¡æ¯ï¼Œä½†æ˜¯ç»†èŠ‚éƒ½å·²ç»ä¸¢å¤±æ‰äº†ã€‚æ‰€ä»¥åœ¨ä¸‹é‡‡æ ·çš„è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸€æ­¥éƒ½ä¼šå åŠ ä¸Šä¸€æ­¥çš„ç‰¹å¾ï¼Œè¿™æ˜¯ä¸ºäº†é˜²æ­¢ç‰¹å¾å˜çš„è¿‡äºæŠ½è±¡ã€‚

è€Œåœ¨ä¸Šé‡‡æ ·çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è¦æŠŠä¿ç•™ä¸‹æ¥çš„ç»†èŠ‚ç‰¹å¾ï¼Œåœ¨ä¸åŒçš„ size å±‚ä¸­å åŠ ä¸Šå»ï¼Œé€æ­¥æ¢å¤åŸå§‹å°ºå¯¸å›¾åƒçš„å…¨éƒ¨ç‰¹å¾ã€‚æ‰€ä»¥ç‰¹å¾å åŠ æ˜¯ä¸‹é‡‡æ ·å’Œä¸Šé‡‡æ ·éƒ½æœ‰åšçš„äº‹æƒ…ï¼Œä½†æ˜¯ä¸Šé‡‡æ ·æ—¶é‡‡ç”¨çš„æ˜¯è·³è·ƒè¿æ¥çš„æ–¹å¼ã€‚

çœŸæ­£çš„å®ç°æ˜¯åœ¨ forward å‡½æ•°ä¸­å®Œæˆçš„ï¼š

```py
# ä¸‹é‡‡æ ·çš„æ—¶å€™ï¼Œé€šè¿‡ hs åˆ—è¡¨ä¿å­˜å åŠ è¿‡çš„ç‰¹å¾ä¿¡æ¯
hs = [h]
h = module(h, t_emb)
hs.append(h)

# ä¸Šé‡‡æ ·çš„æ—¶å€™ï¼Œå¢åŠ ç‰¹å¾ä¿¡æ¯ï¼Œå¹¶å¯¹é½é€šé“æ•°ï¼ˆç»“æ„ä¸­çš„skip_channels.pop()ï¼‰
h = torch.cat([h, hs.pop()], dim=1)
h = module(h, t_emb)
```

### 1.4 ä¸­é—´å±‚å¤„ç†

åœ¨ç»å…¸çš„ U-Net å’Œå¾ˆå¤šæ‰©æ•£æ¨¡å‹ï¼ˆåŒ…æ‹¬ DDPMï¼‰ç»“æ„ä¸­ï¼Œä¸­é—´å±‚ï¼ˆä¹Ÿå« bottleneck æˆ– bridgeï¼‰é€šå¸¸ä¼šæ˜¯ ä¸¤ä¸ª ResidualBlockï¼š

```py
self.middle_block1 = ResidualBlock(ch, ch, time_emb_dim)
self.middle_block2 = ResidualBlock(ch, ch, time_emb_dim)
```

æˆ‘æ€»ç»“äº†ä¸€ä¸‹ï¼Œå¤§è‡´æœ‰ä¸‰ç‚¹åŸå› ï¼šç»éªŒä¸»ä¹‰ã€ä¿¡æ¯èåˆã€å¯¹ç§°ç»“æ„ã€‚

**1. ç»éªŒä¸»ä¹‰**ï¼šåŸå§‹ U-Netã€ResNet ä¸­é—´éƒ¨åˆ†å‡ ä¹éƒ½ä¸æ­¢ä¸€ä¸ªæ¨¡å—ï¼›è€Œ DDPM çš„å‚è€ƒå®ç°ï¼ˆåŒ…æ‹¬ IDMã€Latent-Diffusionï¼‰ä¹Ÿéƒ½åœ¨ä¸­é—´ç”¨äº†å¤šä¸ª ResBlockï¼›ç”šè‡³æœ‰ä¸€äº›è®ºæ–‡è¿˜ä¼šåŠ å…¥ Cross Attentionã€Transformer Block ç­‰é¢å¤–æ¨¡å—ï¼Œè¯´æ˜ä¸­é—´å±‚æ˜¯å¯ä»¥ã€æˆ–è€…è¯´åº”è¯¥è¢«åŠ æ·±çš„ã€‚

**2. ä¿¡æ¯èåˆ**ï¼šä¸­é—´å±‚æ˜¯å…¨ç½‘ç»œä¸­æ„Ÿå—é‡æœ€å¤§ã€æŠ½è±¡ç¨‹åº¦æœ€é«˜çš„éƒ¨åˆ†ï¼Œç»è¿‡äº†å¤šè½®å·ç§¯å’Œæ± åŒ–åçš„å…¨å±€è¡¨ç¤ºå°±æµ“ç¼©åœ¨è¿™é‡Œã€‚ç”¨ä¸¤ä¸ª block å¯ä»¥æ›´å……åˆ†åœ°è¿›è¡ŒæŠ½è±¡ç‰¹å¾çš„èåˆï¼Œé¿å…å•ä¸ª block å­¦ä¸åˆ°è¶³å¤Ÿå¤šçš„ä¿¡æ¯ï¼ˆå°¤å…¶åœ¨å¤§æ¨¡å‹æˆ–å¤æ‚ä»»åŠ¡ä¸­ï¼‰ã€‚

**3. å¯¹ç§°ç»“æ„**ï¼šä¸‹é‡‡æ ·éƒ¨åˆ†ï¼Œæ¯ä¸€å±‚æœ‰ä¸¤ä¸ª ResidualBlockï¼›ä¸Šé‡‡æ ·éƒ¨åˆ†ï¼Œæ¯ä¸€å±‚ä¹Ÿæœ‰ä¸¤ä¸ª ResidualBlockï¼›ä¸­é—´éƒ¨åˆ†ï¼Œä½œä¸ºâ€œå‹ç¼©â€ä¸â€œè¿˜åŸâ€çš„äº¤ç•Œç‚¹ï¼Œä¹Ÿæ¥ä¸¤ä¸ªï¼Œæ˜¯ä¸€ç§ç»“æ„å¯¹é½å’Œä¿¡æ¯æ¡¥æ¢çš„ä½“ç°ã€‚

## 2. ä¸‹é‡‡æ · Downsample

```py
# æ›´å¸¸è§äº U-Net å’Œ Diffusion é‡Œï¼Œä¿¡æ¯ä¿ç•™å¾—æ›´ç»†è…»ä¸€äº›ã€‚
self.op = nn.Conv2d(channels, channels, 3, stride=2, padding=1)

# ç”¨äºå›¾åƒå°ºå¯¸ä¸ºå¶æ•°çš„æƒ…å†µï¼Œèƒ½ç²¾å‡†ç¼©å°1å€ï¼Œä½†è¾¹ç•Œæ›´â€œç¡¬â€
self.op = nn.Conv2d(channels, channels, 4, stride=2, padding=1)
```

å…ˆçœ‹ä¸€ä¸‹è®¡ç®—çš„å…¬å¼ä¸¾ä¾‹ï¼š

![](../public/docsImg/Downsample.jpeg)

- kernel=3, stride=2, padding=1 æ˜¯ä¸€ç§ æ›´å¹³æ»‘ã€è¿‡æ¸¡è‡ªç„¶ çš„æ–¹å¼ï¼Œä¸ä¼šäº§ç”Ÿæ˜æ˜¾çš„ block artifactï¼ˆå—çŠ¶ä¼ªå½±ï¼‰ï¼Œå¸¸ç”¨äºå›¾åƒç”Ÿæˆä»»åŠ¡ä¸­ã€‚
- kernel=4, stride=2, padding=1 æ˜¯ å¸¸è§çš„â€œç²¾ç¡®ä¸‹é‡‡æ ·â€å·ç§¯æ–¹å¼ï¼ˆæ¯”å¦‚ DCGAN å°±ç”¨è¿™ä¸ªï¼‰ã€‚

## 3. ä¸Šé‡‡æ · Upsample

```py
self.op = nn.ConvTranspose2d(channels, channels, 4, stride=2, padding=1)
```

Conv2d æ˜¯å‹ç¼©ç»“æ„ï¼Œå®ƒå¤©ç„¶ä¼šæŠŠç›¸é‚»åƒç´ å‹è¿›ä¸€ä¸ªæ ¼å­é‡Œã€‚è€Œ ConvTranspose2d æ˜¯ä¸€ç§ å¯å­¦ä¹ çš„ä¸Šé‡‡æ ·æ–¹æ³•ï¼Œæ¯”ç®€å•çš„ Upsample æ›´å¼ºå¤§ï¼ˆæ¯”å¦‚ nn.Upsample(mode="nearest") å°±å¾ˆç¬¨ï¼‰ã€‚

ConvTranspose2d èƒ½å˜å¤§çš„åŸç†æ˜¯ï¼šå®ƒæ˜¯è½¬ç½®å·ç§¯ï¼Œä¹Ÿå«åå·ç§¯ï¼ˆdeconvolutionï¼‰ï¼š

1. å®ƒçš„æœ¬è´¨æ˜¯ï¼šå…ˆåœ¨è¾“å…¥ä¹‹é—´æ’å…¥ 0ï¼Œå†ç”¨æ™®é€šå·ç§¯æ»‘è¿‡å»
2. æ’è¿›å»çš„ 0 ä¼šè¢«å·ç§¯æ ¸ã€Œå­¦ä¹ ç€å¡«æ»¡ã€
3. æ‰€ä»¥å®ƒçš„è¾“å‡ºå›¾åƒæ›´å¤§ï¼Œä¿¡æ¯ä¹Ÿæ›´ä¸°å¯Œ
4. æ¯”èµ· nn.Upsampleï¼Œå®ƒèƒ½è®©æ¨¡å‹è‡ªå·±å†³å®šæ’ä»€ä¹ˆå€¼ï¼Œè€Œä¸æ˜¯æ­»æ¿åœ°å¤åˆ¶/æ’å€¼

è€Œè¿™é‡Œçš„å·ç§¯æ ¸ä¸ºä»€ä¹ˆæ˜¯ 4ï¼Œæ˜¯å› ä¸ºå·ç§¯å…¬å¼ä¸ä¸€æ ·ï¼š

![](../public/docsImg/Upsample.jpeg)

## 4. æ®‹å·®å— ResidualBlock

å¤§å¤šæ•°çš„ç»“æ„éƒ½å·²ç»åœ¨å‰é¢è®²è¿‡äº†ï¼Œå½’ä¸€åŒ–ã€æ¿€æ´»å‡½æ•°ã€å·ç§¯å±‚ç­‰ç­‰ã€‚è®²ä¸€ä¸‹ self.skipï¼š

```py
if in_channels != out_channels:
   self.skip = nn.Conv2d(in_channels, out_channels, 1)
else:
   self.skip = nn.Identity()  # Identity è¡¨ç¤ºä»€ä¹ˆéƒ½ä¸å˜ï¼Œç›¸å½“äºå ä½ç¬¦
```

è¿™æ˜¯ç”¨ä½œå åŠ ç‰¹å¾ä¿¡æ¯çš„å‰ç½®æ¡ä»¶ï¼ŒResidualBlock æ€»å…±åšäº†ä¸‰ä»¶äº‹ï¼Œé€šé“æ•°å˜æ¢ + æ—¶é—´èåˆ + ç‰¹å¾å åŠ ã€‚åœ¨å åŠ ä¸Šä¸€æ¬¡å›¾åƒç‰¹å¾æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°é€šé“æ•°å˜åŒ–äº†çš„æƒ…å†µï¼Œæ‰€ä»¥éœ€è¦ç”¨ä¸€ä¸ªå·ç§¯ï¼Œå¯¹é½é€šé“æ•°ã€‚

```py
# x å½’ä¸€åŒ– -> æ¿€æ´»å‡½æ•° -> å·ç§¯
h = self.conv1(self.activation(self.norm1(x)))
# åµŒå…¥çš„æ—¶é—´æ­¥ t_embï¼Œå…ˆé€šè¿‡ time_emb_proj å¯¹é½é€šé“æ•°ï¼Œå†å¹¿æ’­æˆä¸€è‡´çš„å½¢çŠ¶
h += self.time_emb_proj(t_emb)[:, :, None, None]
# dropout=0.1 è¡¨ç¤ºç¨å¾®ä¸¢å¤±ä¸€ç‚¹ç¥ç»å…ƒï¼ˆé€šé“æ•°ï¼‰ï¼Œæé«˜æ³›åŒ–èƒ½åŠ›ï¼Œé˜²æ­¢æ¨¡å‹å¤ªä¾èµ–æŸä¸€éƒ¨åˆ†ç‰¹å¾
h = self.conv2(self.dropout(self.activation(self.norm2(h))))
# å½“å‰å¤„ç†åçš„å›¾åƒ h å åŠ ä¸Šä¸€æ¬¡å›¾åƒ x çš„ç‰¹å¾
return h + self.skip(x)
```
