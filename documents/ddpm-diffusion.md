## 1. æ„é€ å‡½æ•° init

å› ä¸ºæœ‰å…³çš„è®¡ç®—éƒ½è¢«æˆ‘ç§»åŠ¨åˆ°äº† noise_schedule å½“ä¸­ï¼Œæ‰€ä»¥æ„é€ å‡½æ•°çœ‹èµ·æ¥å·²ç»ååˆ†å¹²å‡€åˆ©ç´¢äº†ã€‚éœ€è¦è¯´æ˜çš„åªæœ‰ï¼š

```py
# noise_schedule æ˜¯ä¸€ä¸ªåŒ…å«å’Œ beta ç›¸å…³è®¡ç®—çš„å€¼çš„å­—å…¸
noise_schedule = get_noise_schedule(timesteps)
# è·å–å­—å…¸ä¸­çš„ é”®-å€¼å¯¹ï¼Œk-v
for k, v in noise_schedule.items():
    """
    setattr æ˜¯ Python çš„ä¸€ä¸ªå†…ç½®å‡½æ•°ï¼Œç”¨æ¥ç»™å¯¹è±¡åŠ¨æ€åœ°è®¾ç½®å±æ€§å’Œå€¼ï¼Œ
    å› ä¸ºè¿™äº›å€¼ v éœ€è¦åœ¨GPUä¸Šå’Œå›¾åƒåšè¿ç®—ï¼Œæ‰€ä»¥ä½¿ç”¨ torch.from_numpy
    ä» numpy å˜ä¸º tensorï¼ŒåŒæ—¶è½¬ç§»ç»™ device
    """
    setattr(self, k, torch.from_numpy(v).to(device))
```

## 2. å‰å‘æ‰©æ•£ç›¸å…³å‡½æ•°

### 2.1 q_sample

![æ‰©æ•£è¿‡ç¨‹ - åŠ å™ªå…¬å¼](../public/docsImg/add_noise.jpeg)

```py
noise = torch.randn_like(x_start)
```

torch.randn_like(x_start) çš„ä½œç”¨å°±æ˜¯ç”Ÿæˆä¸€å¼  ä¸ x_start å½¢çŠ¶ä¸€è‡´ çš„é«˜æ–¯ç™½å™ªå£°å›¾åƒã€‚

è¿™ä¸ªå‰å‘æ‰©æ•£çš„å‡½æ•°ï¼Œè™½ç„¶åªè°ƒç”¨æ‰§è¡Œä¸€æ¬¡ï¼Œä½† Î±ã€Î² æ˜¯æ•´ä¸ªæ—¶é—´åºåˆ—ã€‚æ¯”å¦‚æˆ‘ä»¬æ‰©æ•£æ­¥æ•°ä¸º 1000 æ­¥ï¼Œé‚£ä¹ˆ get_noise_schedule ä¸­çš„æ‰€æœ‰è®¡ç®—çš„æ•°æ®ï¼Œéƒ½æ˜¯ 1000 ä¸ªå€¼çš„ä¸€ç»´æ•°ç»„ã€‚

æ‰€ä»¥åœ¨è®­ç»ƒçš„æ—¶å€™ï¼Œå®é™…ä¸Šæ˜¯ä¸€æ¬¡æ€§ï¼Œå°† 1000 å¼ ä»åŸå›¾åˆ°çº¯å™ªå£°çš„å›¾åƒï¼Œå…¨éƒ¨éƒ½è®¡ç®—å®Œæ¯•äº†ã€‚

### 2.2 q_posterior

ï¼ˆ1ï¼‰çœŸå®åéªŒå‡å€¼

![åéªŒåˆ†å¸ƒ - å‡å€¼](../public/docsImg/posterior_mean.jpeg)

ï¼ˆ2ï¼‰çœŸå®åéªŒæ–¹å·®

![åéªŒåˆ†å¸ƒ - æ–¹å·®](../public/docsImg/posterior_variance.jpeg)

è¿™äº›ç›¸å…³çš„å‚æ•°éƒ½å·²ç»è®¡ç®—å¥½äº†ï¼Œposterior_mean_coef1ï¼Œposterior_mean_coef2ï¼Œposterior_varianceï¼Œposterior_log_variance_clippedã€‚

æ‰€æœ‰çš„ extract è°ƒç”¨åªæ˜¯ä¸ºäº†è®©è¿™äº›å‚æ•°ï¼Œç¬¦åˆå½“å‰æ‰¹æ¬¡å›¾åƒçš„æ•°é‡ï¼Œä»¥åŠå›¾åƒçš„ Sizeï¼Œä»è€Œæ–¹ä¾¿åœ¨ GPU ä¸Šå’Œå›¾åƒåšè¿ç®—ã€‚

çœŸå®åéªŒåˆ†å¸ƒï¼Œæˆ‘åˆšå¼€å§‹å¾ˆä¸ç†è§£ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå«ï¼Œç®€å•æ¦‚æ‹¬æ¥è¯´ï¼š

1. å®ƒæ˜¯æ ¹æ®æˆ‘ä»¬å®šä¹‰çš„æ‰©æ•£è¿‡ç¨‹ç²¾ç¡®å¯è®¡ç®—çš„ï¼›
2. å®ƒæ˜¯ç”Ÿæˆ x\_(t-1) çš„æœ€ä¼˜ç†è®ºåˆ†å¸ƒï¼Œå³æˆ‘ä»¬ç†æƒ³ä¸­åº”è¯¥ç”¨çš„åˆ†å¸ƒï¼›
3. ä½†åœ¨å®é™…ä¸­ï¼Œæˆ‘ä»¬åªèƒ½è¿‘ä¼¼å®ƒï¼Œæ¯”å¦‚é€šè¿‡ç½‘ç»œé¢„æµ‹çš„ x_0 æ¥ä¼°ç®—å®ƒï¼Œæ‰€ä»¥å«â€œçœŸå®â€ã€‚

è¯¦ç»†æ¥è¯´ï¼Œè¯·çœ‹å›¾ï¼Œæˆ‘é—­å˜´ï¼š

![ä»€ä¹ˆå«çœŸå®åéªŒåˆ†å¸ƒ](../public/docsImg/true_posterior.jpeg)

### 2.3 p_losses

æŸå¤±å‡½æ•°ï¼Œå®ƒæ˜¯åœ¨è®­ç»ƒé˜¶æ®µä½¿ç”¨çš„ï¼Œæ‰€ä»¥æˆ‘æŠŠå®ƒæ”¾åœ¨äº†å‰é¢ã€‚å®ƒå¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯ä½¿ç”¨äº†å‡æ–¹è¯¯å·®ï¼ˆMean Squared Error, MSEï¼‰ï¼Œæ¥è¡¡é‡

- q_sample å‰å‘æ‰©æ•£è¿‡ç¨‹ä¸­ï¼Œç»è¿‡åŠ å™ªçš„æ‰€æœ‰å›¾åƒ
- model(x_t, t) æ¨¡å‹é¢„æµ‹çš„å™ªéŸ³

ä¸¤è€…ä¹‹é—´çš„å·®å¼‚ã€‚

## 3. é€†å‘ç”Ÿæˆç›¸å…³å‡½æ•°

### 3.1 predict_start_from_noise

é€šè¿‡å½“å‰æ—¶åˆ»çš„å›¾åƒ x_t å’Œæ¨¡å‹é¢„æµ‹çš„å™ªå£° Îµï¼Œæ¨ç®—å‡ºæœ€åˆå§‹å›¾åƒ x_0 çš„ä¼°è®¡å€¼ã€‚

ğŸŒ± èƒŒåæ•°å­¦æ¨å¯¼

![](../public/docsImg/predict_start.jpeg)

ğŸŒ¸ ç›¸å…³çš„å˜é‡ç³»æ•°ï¼ŒåŒæ ·ä¹Ÿå·²ç»è¢«è®¡ç®—å¥½äº†

![](../public/docsImg/predict_start1.jpeg)

### 3.2 p_sample

é‡‡æ ·çš„è¿‡ç¨‹åœ¨å‡½æ•°ä¸­éƒ½å·²ç»æ³¨æ˜äº†æ¯ä¸€ä¸ªæ­¥éª¤çš„ä½œç”¨ï¼Œå…³äºæ–¹å·®é€‰æ‹©ï¼ˆModelVarType.FIXED_LARGEï¼‰çš„éƒ¨åˆ†åœ¨ ddpm-utils ä¸­æœ‰è¯´æ˜ã€‚

### 3.3 p_sample_loop

è¿™é‡Œéœ€è¦ç€é‡è¯´æ˜ä¸€ä¸‹ã€‚DDPM æ‰€è°“çš„å»å™ªè¿‡ç¨‹ï¼Œå¹¶ä¸ç­‰åŒäºå¯¹ä¸€å¼ å›¾åƒè¿›è¡Œå¤åŸï¼Œæœ¬è´¨ä¸Šæ˜¯ç”Ÿæˆã€‚

```py
x_t = torch.randn(shape, device=device)
```

ä»è¿™ä¸ªå‡½æ•°çš„ç¬¬ä¸€è¡Œä»£ç æˆ‘ä»¬çŸ¥é“ï¼Œæœ€åˆçš„å›¾åƒå°±æ˜¯ä¸€ä¸ªéšæœºçš„ç¬¦åˆé«˜æ–¯åˆ†å¸ƒçš„ç™½å™ªå£°ã€‚æˆ‘åšäº†å®éªŒï¼ŒåŸæœ¬ä»¥ä¸ºä¸€å¼ å›¾åƒåšè®­ç»ƒçš„è¯ï¼Œä»–åº”è¯¥èƒ½å®Œç¾çš„å¤åŸå‡ºåŸæœ¬çš„å›¾åƒå§ï¼Œå¾ˆé—æ†¾å®ƒä¸èƒ½ã€‚

å›é¡¾ä¸€ä¸‹ï¼ŒDDPM å«åš**å»å™ªæ‰©æ•£==æ¦‚ç‡==æ¨¡å‹**ï¼ŒDDPM ä¸å­¦ä¹ å›¾åƒï¼Œå®ƒå­¦ä¹ ==åˆ†å¸ƒ==ã€‚åœ¨ DDPM é‡Œï¼Œæ¨¡å‹çš„ç›®æ ‡æ˜¯å­¦ä¹ å¦‚ä½•ä»é«˜æ–¯å™ªå£°ä¸€æ­¥æ­¥è¿˜åŸå‡ºä¸€ä¸ªçœŸå®å›¾åƒåˆ†å¸ƒçš„æ ·æœ¬ã€‚å®ƒä¸åœ¨ä¹ä¸€å¼ å›¾åƒå…·ä½“æ˜¯ä»€ä¹ˆï¼Œè€Œåœ¨äºï¼š

1. â€œä¸€å¼ å¥½å›¾åƒé€šå¸¸é•¿ä»€ä¹ˆæ ·â€
2. â€œåƒç´ æ€ä¹ˆç»„åˆæ‰æ˜¯åˆç†çš„â€
3. â€œæœ‰å‰æ™¯å°±è¯¥æœ‰èƒŒæ™¯ï¼Œæœ‰è½®å»“å°±è¯¥æœ‰çº¹ç†â€

ä¸€å¼ å›¾åƒåªæ˜¯ä¸€ä¸ªç‚¹ï¼Œè€Œæ¨¡å‹å­¦ä¹ çš„æ˜¯ç‚¹çš„åˆ†å¸ƒã€‚ä½ ç»™å®ƒä¸€å¼ å›¾ï¼Œé‚£åˆ†å¸ƒå°±å˜æˆäº†ä¸€ä¸ªç‚¹ â€”> æ¨¡å‹åªçœ‹åˆ°ä¸€ç§å¯èƒ½ï¼Œæ²¡æœ‰ç»Ÿè®¡æ„ä¹‰ã€‚

ğŸ”¬ **ä»è§†è§‰ç†è§£ä¸€å¼ å›¾éš¾ä»¥è®­ç»ƒçš„ç°è±¡**

æˆ‘ä»¬è„‘è¡¥ä¸€ä¸‹æ¨¡å‹æ˜¯æ€ä¹ˆå­¦ä¹ çš„ã€‚ä½ ç»™å®ƒä¸€å¼ å›¾ï¼Œç„¶åè¯´â€œä½ è¦å­¦ä¼šä»éšæœºå™ªå£°ç”Ÿæˆå®ƒâ€ï¼Œæ¨¡å‹å°±ä¼šé—®ï¼š

- ã€Œå“ªé‡Œæ˜¯äººè„¸ï¼Ÿå“ªé‡Œæ˜¯èƒŒæ™¯ï¼Ÿã€
- ã€Œäººè„¸åº”è¯¥å¤šå¤§ï¼Ÿé¼»å­åœ¨å“ªä¸ªä½ç½®ï¼Ÿã€
- ã€Œçœ¼ç›æ˜¯åœ†çš„ï¼Ÿæ¤­åœ†çš„ï¼ŸèƒŒæ™¯æ˜¯ç™½çš„å—ï¼Ÿã€

ä½†ç”±äºå®ƒ åªçœ‹åˆ°ä¸€å¼ å›¾ï¼Œå®ƒå°±ä¸çŸ¥é“å“ªäº›æ˜¯å¶ç„¶çš„ï¼Œå“ªäº›æ˜¯å¿…ç„¶çš„ã€‚äºæ˜¯æ¨¡å‹äº§ç”Ÿå¹»è§‰ï¼šâ€œå“¦ï¼ŒåŸæ¥å›¾åƒå°±æ˜¯å™ªå£°... æˆ‘èƒ½ç”Ÿæˆä¸€å †ï¼â€

```py
# é‡‡æ ·ä¸æ˜¯è®­ç»ƒï¼Œä¸ç”¨è®¡ç®—æ¢¯åº¦ï¼Œå‡å°‘èµ„æºæ¶ˆè€—
with torch.no_grad():
    # å¯¹åŠ å™ªçš„æ—¶é—´æ­¥æ•°ç»„è¿›è¡Œé€†åºæ“ä½œï¼Œä» 1000 -> 0
    for i in reversed(range(self.timesteps)):
        # å¯¹æ¯ä¸€ä¸ªæ—¶é—´æ­¥è¿›è¡Œå½¢çŠ¶æ‰©å……ï¼Œshape[0] è¡¨ç¤º [B]ï¼Œbatch size
        # åŒæ—¶è½¬åŒ–ä¸º tensorï¼Œä»¥ä¾¿åœ¨ p_sample ä¸­å’Œ x_t ä¸€èµ·é€å…¥æ¨¡å‹
        t = torch.full((shape[0],), i, device=device, dtype=torch.long)
        x_t = self.p_sample(model, x_t, t)
```

### 3.4 sample

è¿™ä¸ªå‡½æ•°æ›´å¥½ç†è§£äº†ï¼Œå°è£…äº† p_sample_loopï¼Œç”¨äºå¤–éƒ¨è°ƒç”¨ã€‚
